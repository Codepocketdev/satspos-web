<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#667eea">
    <meta name="description" content="Lightning POS with Bluetooth thermal printer support">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="SatsPOS">
    <link rel="manifest" href="manifest.json">
    <link rel="icon" type="image/png" sizes="192x192" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='0.9em' font-size='90'>‚ö°</text></svg>">
    <title>SatsPOS - Bluetooth Thermal Printer</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 500px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        
        h1 {
            color: #333;
            margin-bottom: 10px;
            font-size: 28px;
        }
        
        .subtitle {
            color: #666;
            margin-bottom: 30px;
            font-size: 14px;
        }
        
        .status {
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .status.info {
            background: #e3f2fd;
            color: #1976d2;
        }
        
        .status.success {
            background: #e8f5e9;
            color: #388e3c;
        }
        
        .status.error {
            background: #ffebee;
            color: #d32f2f;
        }
        
        .status.warning {
            background: #fff3e0;
            color: #f57c00;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            color: #555;
            font-weight: 600;
            font-size: 14px;
        }
        
        input {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 16px;
            transition: border-color 0.3s;
        }
        
        input:focus {
            outline: none;
            border-color: #667eea;
        }
        
        button {
            width: 100%;
            padding: 15px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 10px;
        }
        
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        button:active {
            transform: scale(0.98);
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }
        
        .btn-secondary {
            background: #f5f5f5;
            color: #333;
        }
        
        .btn-secondary:hover:not(:disabled) {
            background: #e0e0e0;
        }
        
        .btn-success {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            color: white;
        }
        
        .printer-info {
            background: #f5f5f5;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            font-size: 14px;
        }
        
        .printer-info strong {
            display: block;
            margin-bottom: 5px;
            color: #333;
        }
        
        #qrcode {
            text-align: center;
            margin: 20px 0;
            padding: 20px;
            background: white;
            border-radius: 10px;
        }
        
        #qrcode canvas, #qrcode img {
            max-width: 100%;
            height: auto;
        }
        
        .hidden {
            display: none;
        }
        
        .invoice-display {
            background: #f9f9f9;
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
            word-break: break-all;
            font-family: monospace;
            font-size: 12px;
            max-height: 150px;
            overflow-y: auto;
        }
        
        .install-prompt {
            position: fixed;
            bottom: 20px;
            left: 20px;
            right: 20px;
            background: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            z-index: 1000;
            animation: slideUp 0.3s ease;
        }
        
        @keyframes slideUp {
            from {
                transform: translateY(100px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }
        
        .install-prompt h3 {
            margin-bottom: 10px;
            color: #333;
        }
        
        .install-prompt p {
            margin-bottom: 15px;
            color: #666;
            font-size: 14px;
        }
        
        .install-buttons {
            display: flex;
            gap: 10px;
        }
        
        .install-buttons button {
            flex: 1;
            margin: 0;
        }
        
        .history-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            border-radius: 15px;
            color: white;
            text-align: center;
        }
        
        .stat-label {
            font-size: 12px;
            opacity: 0.9;
            margin-bottom: 8px;
        }
        
        .stat-value {
            font-size: 20px;
            font-weight: bold;
        }
        
        .history-filters {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .history-filters select {
            flex: 1;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 14px;
        }
        
        .transaction-item {
            background: #f9f9f9;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 10px;
            border-left: 4px solid #667eea;
        }
        
        .transaction-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        
        .transaction-item-name {
            font-weight: 600;
            color: #333;
        }
        
        .transaction-amount {
            font-weight: bold;
            color: #38ef7d;
            font-size: 16px;
        }
        
        .transaction-date {
            font-size: 12px;
            color: #666;
        }
        
        .no-transactions {
            text-align: center;
            padding: 40px;
            color: #999;
        }
        
        .currency-toggle {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .toggle-btn {
            flex: 1;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            background: white;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s;
        }
        
        .toggle-btn.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-color: #667eea;
        }
        
        .conversion-display {
            margin-top: 10px;
            padding: 12px;
            background: #f0f7ff;
            border-radius: 8px;
            color: #1976d2;
            font-weight: 600;
            text-align: center;
        }
        
        .rate-info {
            font-size: 12px;
            color: #666;
            text-align: center;
            margin-bottom: 15px;
        }
        
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            padding: 20px;
        }
        
        .modal-content {
            background: white;
            border-radius: 20px;
            padding: 30px;
            max-width: 500px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .modal-content h3 {
            margin-bottom: 20px;
            color: #333;
        }
        
        #imagePreview {
            margin-top: 10px;
            text-align: center;
        }
        
        #imagePreview img {
            max-width: 200px;
            max-height: 200px;
            border-radius: 10px;
            border: 2px solid #e0e0e0;
        }
        
        #productGrid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: 15px;
        }
        
        .product-card {
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 15px;
            overflow: hidden;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
        }
        
        .product-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
            border-color: #667eea;
        }
        
        .product-card.selected {
            border-color: #38ef7d;
            border-width: 3px;
        }
        
        .product-image {
            width: 100%;
            height: 120px;
            object-fit: cover;
            background: #f5f5f5;
        }
        
        .product-info {
            padding: 10px;
        }
        
        .product-name {
            font-weight: 600;
            font-size: 14px;
            color: #333;
            margin-bottom: 5px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .product-price {
            color: #667eea;
            font-weight: bold;
            font-size: 13px;
        }
        
        .product-actions {
            display: flex;
            gap: 5px;
            padding: 10px;
            background: #f9f9f9;
        }
        
        .product-actions button {
            flex: 1;
            padding: 8px;
            font-size: 12px;
            margin: 0;
        }
        
        .cart-container {
            background: #f9f9f9;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
        }
        
        .cart-container h3 {
            margin-bottom: 15px;
            color: #333;
        }
        
        .cart-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background: white;
            border-radius: 10px;
            margin-bottom: 10px;
        }
        
        .cart-item-info {
            flex: 1;
        }
        
        .cart-item-name {
            font-weight: 600;
            color: #333;
        }
        
        .cart-item-price {
            font-size: 12px;
            color: #666;
        }
        
        .cart-item-controls {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .qty-btn {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            border: 2px solid #667eea;
            background: white;
            color: #667eea;
            font-weight: bold;
            cursor: pointer;
            padding: 0;
            margin: 0;
        }
        
        .qty-btn:hover {
            background: #667eea;
            color: white;
        }
        
        .cart-qty {
            min-width: 30px;
            text-align: center;
            font-weight: 600;
        }
        
        .cart-total {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 2px solid #e0e0e0;
            font-size: 18px;
            display: flex;
            justify-content: space-between;
        }
        
        .cart-total span {
            color: #38ef7d;
            font-weight: bold;
        }
        
        .no-products {
            text-align: center;
            padding: 40px;
            color: #999;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>‚ö° SatsPOS</h1>
        <p class="subtitle">Lightning Payments + Bluetooth Thermal Printer</p>
        
        <div id="statusBox" class="status info">
            üì± Ready to connect to Bluetooth printer
        </div>
        
        <!-- Setup Section -->
        <div id="setupSection">
            <div class="form-group">
                <label>Shop Name</label>
                <input type="text" id="shopName" placeholder="My Coffee Shop" value="Kibera Market">
            </div>
            
            <div class="form-group">
                <label>Shop Address</label>
                <input type="text" id="shopAddress" placeholder="123 Main St" value="Nairobi, Kenya">
            </div>
            
            <button class="btn-primary" onclick="connectPrinter()">
                üîç Scan & Connect Bluetooth Printer
            </button>
            
            <button class="btn-secondary" onclick="skipPrinter()">
                Skip Printer Setup (Save receipts only)
            </button>
        </div>
        
        <!-- Printer Info -->
        <div id="printerInfo" class="printer-info hidden">
            <strong>‚úÖ Printer Connected</strong>
            <div id="printerName">-</div>
        </div>
        
        <!-- Transaction Section -->
        <div id="transactionSection" class="hidden">
            <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                <button class="btn-secondary" style="flex: 1;" onclick="showProducts()">
                    üõçÔ∏è Products
                </button>
                <button class="btn-secondary" style="flex: 1;" onclick="showNewSale()">
                    üí∞ Quick Sale
                </button>
                <button class="btn-secondary" style="flex: 1;" onclick="showHistory()">
                    üìä History
                </button>
            </div>
            
            <!-- Products View -->
            <div id="productsView" class="hidden">
                <button class="btn-primary" onclick="showAddProduct()" style="margin-bottom: 20px;">
                    + Add Product
                </button>
                
                <div id="productGrid"></div>
            </div>
            
            <!-- Add Product Modal -->
            <div id="addProductModal" class="modal hidden">
                <div class="modal-content">
                    <h3>Add Product</h3>
                    
                    <div class="form-group">
                        <label>Product Photo</label>
                        <input type="file" id="productImage" accept="image/*" onchange="previewImage()">
                        <div id="imagePreview"></div>
                    </div>
                    
                    <div class="form-group">
                        <label>Product Name</label>
                        <input type="text" id="productName" placeholder="Coffee">
                    </div>
                    
                    <div class="form-group">
                        <label>Price</label>
                        <div style="display: flex; gap: 10px;">
                            <select id="productCurrency" style="width: 100px;">
                                <option value="sats">Sats</option>
                                <option value="kes">KES üá∞üá™</option>
                                <option value="usd">USD üá∫üá∏</option>
                                <option value="eur">EUR üá™üá∫</option>
                                <option value="ngn">NGN üá≥üá¨</option>
                                <option value="zar">ZAR üáøüá¶</option>
                            </select>
                            <input type="number" id="productPrice" placeholder="1000" style="flex: 1;">
                        </div>
                    </div>
                    
                    <div style="display: flex; gap: 10px;">
                        <button class="btn-success" onclick="saveProduct()" style="flex: 1;">Save</button>
                        <button class="btn-secondary" onclick="closeAddProduct()" style="flex: 1;">Cancel</button>
                    </div>
                </div>
            </div>
            
            <!-- Shopping Cart -->
            <div id="cartView" class="cart-container hidden">
                <h3>Shopping Cart</h3>
                <div id="cartItems"></div>
                <div class="cart-total">
                    <strong>Total:</strong> <span id="cartTotal">0 sats</span>
                </div>
                <button class="btn-success" onclick="checkoutCart()">
                    Generate Invoice
                </button>
                <button class="btn-secondary" onclick="clearCart()">
                    Clear Cart
                </button>
            </div>
            
            <div id="newSaleView">
                <div class="form-group">
                    <label>Lightning Address</label>
                    <input type="text" id="lightningAddress" placeholder="user@walletofsatoshi.com" value="homelyviolin01@walletofsatoshi.com">
                </div>
                
                <div class="form-group">
                    <label>Item Name</label>
                    <input type="text" id="itemName" placeholder="Coffee">
                </div>
                
                <div class="currency-toggle">
                    <button class="toggle-btn active" onclick="switchToFiat()" id="fiatToggle">üíµ Fiat</button>
                    <button class="toggle-btn" onclick="switchToSats()" id="satsToggle">‚ö° Sats</button>
                </div>
                
                <div id="fiatInput" class="form-group">
                    <label>Amount</label>
                    <div style="display: flex; gap: 10px;">
                        <select id="currency" onchange="convertAmount()" style="width: 100px;">
                            <option value="kes">KES üá∞üá™</option>
                            <option value="usd">USD üá∫üá∏</option>
                            <option value="eur">EUR üá™üá∫</option>
                            <option value="gbp">GBP üá¨üáß</option>
                            <option value="ngn">NGN üá≥üá¨</option>
                            <option value="zar">ZAR üáøüá¶</option>
                            <option value="ghs">GHS üá¨üá≠</option>
                            <option value="egp">EGP üá™üá¨</option>
                            <option value="xof">XOF üåç</option>
                            <option value="mad">MAD üá≤üá¶</option>
                        </select>
                        <input type="number" id="fiatAmount" placeholder="1000" oninput="convertAmount()" style="flex: 1;">
                    </div>
                    <div class="conversion-display" id="conversionDisplay"></div>
                </div>
                
                <div id="satsInput" class="form-group hidden">
                    <label>Amount (sats)</label>
                    <input type="number" id="satsAmount" placeholder="1000" oninput="convertFromSats()">
                    <div class="conversion-display" id="satsConversionDisplay"></div>
                </div>
                
                <div class="rate-info" id="rateInfo"></div>
                
                <button class="btn-success" onclick="createInvoice()">
                    Generate Invoice
                </button>
            </div>
            
            <div id="historyView" class="hidden">
                <div class="history-stats">
                    <div class="stat-card">
                        <div class="stat-label">Today</div>
                        <div class="stat-value" id="todayTotal">0 sats</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">This Week</div>
                        <div class="stat-value" id="weekTotal">0 sats</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">This Month</div>
                        <div class="stat-value" id="monthTotal">0 sats</div>
                    </div>
                </div>
                
                <div class="history-filters">
                    <select id="periodFilter" onchange="filterHistory()">
                        <option value="today">Today</option>
                        <option value="week">This Week</option>
                        <option value="month">This Month</option>
                        <option value="all">All Time</option>
                    </select>
                    <button class="btn-secondary" onclick="exportHistory()" style="padding: 10px 20px;">
                        üì• Export CSV
                    </button>
                </div>
                
                <div id="transactionList"></div>
            </div>
        </div>
        
        <!-- Invoice Display -->
        <div id="invoiceSection" class="hidden">
            <div id="qrcode"></div>
            <div class="invoice-display" id="invoiceText"></div>
            
            <button class="btn-success" onclick="confirmPayment()">
                ‚úì Confirm Payment Received
            </button>
            
            <button class="btn-secondary" onclick="cancelTransaction()">
                Cancel
            </button>
        </div>
    </div>
    
    <!-- Install Prompt -->
    <div id="installPrompt" class="install-prompt hidden">
        <h3>üì≤ Install SatsPOS</h3>
        <p>Install this app on your home screen for quick access!</p>
        <div class="install-buttons">
            <button class="btn-primary" onclick="installApp()">Install</button>
            <button class="btn-secondary" onclick="dismissInstall()">Later</button>
        </div>
    </div>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script>
        let printerDevice = null;
        let printerCharacteristic = null;
        let currentInvoice = null;
        let currentTransaction = {};
        let deferredPrompt = null;
        let reconnectAttempts = 0;
        const MAX_RECONNECT_ATTEMPTS = 3;
        let transactionHistory = [];
        let exchangeRates = {};
        let lastRateUpdate = 0;
        const RATE_UPDATE_INTERVAL = 60000;
        let products = [];
        let cart = {};
        let editingProductId = null; // Update every 60 seconds
        
        // Fetch exchange rates
        async function updateExchangeRates() {
            const now = Date.now();
            if (now - lastRateUpdate < RATE_UPDATE_INTERVAL && Object.keys(exchangeRates).length > 0) {
                return; // Use cached rates
            }
            
            try {
                const response = await fetch('https://api.coingecko.com/api/v3/simple/price?ids=bitcoin&vs_currencies=usd,eur,gbp,kes,ngn,zar,ghs,egp,xof,mad');
                const data = await response.json();
                
                if (data.bitcoin) {
                    exchangeRates = data.bitcoin;
                    lastRateUpdate = now;
                    updateRateDisplay();
                }
            } catch (error) {
                console.error('Failed to fetch rates:', error);
                setStatus('‚ö†Ô∏è Unable to fetch exchange rates. Using last known rates.', 'warning');
            }
        }
        
        // Update rate display
        function updateRateDisplay() {
            const currency = document.getElementById('currency').value.toUpperCase();
            const rate = exchangeRates[currency.toLowerCase()];
            if (rate) {
                const satoshiRate = (100000000 / rate).toFixed(0);
                document.getElementById('rateInfo').textContent = `1 ${currency} ‚âà ${Number(satoshiRate).toLocaleString()} sats`;
            }
        }
        
        // Convert fiat to sats
        function convertAmount() {
            const fiatAmount = parseFloat(document.getElementById('fiatAmount').value);
            const currency = document.getElementById('currency').value;
            
            if (!fiatAmount || fiatAmount <= 0) {
                document.getElementById('conversionDisplay').textContent = '';
                return;
            }
            
            const rate = exchangeRates[currency];
            if (!rate) {
                document.getElementById('conversionDisplay').textContent = 'Exchange rate unavailable';
                return;
            }
            
            const btcAmount = fiatAmount / rate;
            const satsAmount = Math.round(btcAmount * 100000000);
            
            document.getElementById('conversionDisplay').textContent = `‚âà ${satsAmount.toLocaleString()} sats`;
            updateRateDisplay();
        }
        
        // Convert sats to fiat
        function convertFromSats() {
            const satsAmount = parseInt(document.getElementById('satsAmount').value);
            const currency = document.getElementById('currency').value;
            
            if (!satsAmount || satsAmount <= 0) {
                document.getElementById('satsConversionDisplay').textContent = '';
                return;
            }
            
            const rate = exchangeRates[currency];
            if (!rate) {
                document.getElementById('satsConversionDisplay').textContent = 'Exchange rate unavailable';
                return;
            }
            
            const btcAmount = satsAmount / 100000000;
            const fiatAmount = (btcAmount * rate).toFixed(2);
            
            document.getElementById('satsConversionDisplay').textContent = `‚âà ${fiatAmount} ${currency.toUpperCase()}`;
        }
        
        // Switch input modes
        function switchToFiat() {
            document.getElementById('fiatToggle').classList.add('active');
            document.getElementById('satsToggle').classList.remove('active');
            document.getElementById('fiatInput').classList.remove('hidden');
            document.getElementById('satsInput').classList.add('hidden');
        }
        
        function switchToSats() {
            document.getElementById('satsToggle').classList.add('active');
            document.getElementById('fiatToggle').classList.remove('active');
            document.getElementById('satsInput').classList.remove('hidden');
            document.getElementById('fiatInput').classList.add('hidden');
        }
        
        // Product Management
        function showAddProduct() {
            editingProductId = null;
            document.getElementById('productName').value = '';
            document.getElementById('productPrice').value = '';
            document.getElementById('productImage').value = '';
            document.getElementById('imagePreview').innerHTML = '';
            document.getElementById('addProductModal').classList.remove('hidden');
        }
        
        function closeAddProduct() {
            document.getElementById('addProductModal').classList.add('hidden');
        }
        
        function previewImage() {
            const file = document.getElementById('productImage').files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    document.getElementById('imagePreview').innerHTML = 
                        `<img src="${e.target.result}" alt="Preview">`;
                };
                reader.readAsDataURL(file);
            }
        }
        
        async function saveProduct() {
            const name = document.getElementById('productName').value.trim();
            const price = parseFloat(document.getElementById('productPrice').value);
            const currency = document.getElementById('productCurrency').value;
            const imageFile = document.getElementById('productImage').files[0];
            
            if (!name || !price || price <= 0) {
                alert('Please fill all fields');
                return;
            }
            
            let satsPrice = price;
            if (currency !== 'sats') {
                const rate = exchangeRates[currency];
                if (!rate) {
                    alert('Exchange rate unavailable');
                    return;
                }
                const btcAmount = price / rate;
                satsPrice = Math.round(btcAmount * 100000000);
            }
            
            let imageData = null;
            if (imageFile) {
                imageData = await new Promise((resolve) => {
                    const reader = new FileReader();
                    reader.onload = (e) => resolve(e.target.result);
                    reader.readAsDataURL(imageFile);
                });
            }
            
            const product = {
                id: editingProductId || Date.now(),
                name,
                price: satsPrice,
                fiatPrice: currency !== 'sats' ? price : null,
                currency: currency !== 'sats' ? currency : null,
                image: imageData
            };
            
            if (editingProductId) {
                const index = products.findIndex(p => p.id === editingProductId);
                products[index] = product;
            } else {
                products.push(product);
            }
            
            saveProducts();
            displayProducts();
            closeAddProduct();
        }
        
        function deleteProduct(id) {
            if (confirm('Delete this product?')) {
                products = products.filter(p => p.id !== id);
                saveProducts();
                displayProducts();
            }
        }
        
        function displayProducts() {
            const grid = document.getElementById('productGrid');
            
            if (products.length === 0) {
                grid.innerHTML = '<div class="no-products">No products yet. Add your first product!</div>';
                return;
            }
            
            grid.innerHTML = products.map(p => {
                const imgSrc = p.image || 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><rect width="100" height="100" fill="%23e0e0e0"/><text x="50" y="55" font-size="40" text-anchor="middle" fill="%23999">?</text></svg>';
                let priceDisplay = `${p.price.toLocaleString()} sats`;
                if (p.fiatPrice && p.currency) {
                    priceDisplay = `${p.fiatPrice} ${p.currency.toUpperCase()}`;
                }
                
                return `
                    <div class="product-card" onclick="addToCart(${p.id})">
                        <img src="${imgSrc}" alt="${p.name}" class="product-image">
                        <div class="product-info">
                            <div class="product-name">${p.name}</div>
                            <div class="product-price">${priceDisplay}</div>
                        </div>
                        <div class="product-actions">
                            <button class="btn-secondary" onclick="event.stopPropagation(); deleteProduct(${p.id})">üóëÔ∏è</button>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        // Cart Management
        function addToCart(productId) {
            const product = products.find(p => p.id === productId);
            if (!product) return;
            
            if (cart[productId]) {
                cart[productId].quantity++;
            } else {
                cart[productId] = {
                    ...product,
                    quantity: 1
                };
            }
            
            displayCart();
        }
        
        function updateCartQuantity(productId, change) {
            if (!cart[productId]) return;
            
            cart[productId].quantity += change;
            
            if (cart[productId].quantity <= 0) {
                delete cart[productId];
            }
            
            displayCart();
        }
        
        function displayCart() {
            const cartView = document.getElementById('cartView');
            const cartItems = document.getElementById('cartItems');
            const cartTotal = document.getElementById('cartTotal');
            
            const items = Object.values(cart);
            
            if (items.length === 0) {
                cartView.classList.add('hidden');
                return;
            }
            
            cartView.classList.remove('hidden');
            
            let totalSats = 0;
            cartItems.innerHTML = items.map(item => {
                const itemTotal = item.price * item.quantity;
                totalSats += itemTotal;
                
                return `
                    <div class="cart-item">
                        <div class="cart-item-info">
                            <div class="cart-item-name">${item.name}</div>
                            <div class="cart-item-price">${item.price.toLocaleString()} sats each</div>
                        </div>
                        <div class="cart-item-controls">
                            <button class="qty-btn" onclick="updateCartQuantity(${item.id}, -1)">‚àí</button>
                            <span class="cart-qty">${item.quantity}</span>
                            <button class="qty-btn" onclick="updateCartQuantity(${item.id}, 1)">+</button>
                        </div>
                    </div>
                `;
            }).join('');
            
            cartTotal.textContent = `${totalSats.toLocaleString()} sats`;
        }
        
        function clearCart() {
            if (confirm('Clear cart?')) {
                cart = {};
                displayCart();
            }
        }
        
        async function checkoutCart() {
            const items = Object.values(cart);
            if (items.length === 0) return;
            
            const lightningAddr = document.getElementById('lightningAddress').value.trim();
            if (!lightningAddr) {
                alert('Please enter Lightning Address in Quick Sale tab');
                return;
            }
            
            const itemNames = items.map(i => `${i.name} x${i.quantity}`).join(', ');
            const totalAmount = items.reduce((sum, i) => sum + (i.price * i.quantity), 0);
            
            // Create invoice for cart
            try {
                setStatus('üîç Resolving lightning address...', 'info');
                
                const [user, domain] = lightningAddr.split('@');
                const lnurlUrl = `https://${domain}/.well-known/lnurlp/${user}`;
                
                const lnurlResp = await fetch(lnurlUrl);
                const lnurlData = await lnurlResp.json();
                
                setStatus('üìÑ Requesting invoice...', 'info');
                
                const callback = lnurlData.callback;
                const msat = totalAmount * 1000;
                const invoiceUrl = `${callback}?amount=${msat}&memo=${encodeURIComponent(itemNames)}`;
                
                const invoiceResp = await fetch(invoiceUrl);
                const invoiceData = await invoiceResp.json();
                
                currentInvoice = invoiceData.pr || invoiceData.paymentRequest;
                
                if (!currentInvoice) {
                    throw new Error('No invoice in response');
                }
                
                currentTransaction = {
                    shopName: document.getElementById('shopName').value,
                    shopAddress: document.getElementById('shopAddress').value,
                    lightningAddr,
                    itemName: itemNames,
                    amount: totalAmount,
                    fiatAmount: null,
                    currency: null,
                    invoice: currentInvoice,
                    timestamp: new Date().toISOString(),
                    cartItems: items
                };
                
                document.getElementById('qrcode').innerHTML = '';
                new QRCode(document.getElementById('qrcode'), {
                    text: currentInvoice,
                    width: 256,
                    height: 256
                });
                
                document.getElementById('invoiceText').textContent = currentInvoice;
                document.getElementById('transactionSection').classList.add('hidden');
                document.getElementById('invoiceSection').classList.remove('hidden');
                
                setStatus('‚úÖ Invoice generated! Waiting for payment...', 'success');
                
                // Clear cart after checkout
                cart = {};
                displayCart();
                
            } catch (error) {
                console.error('Invoice error:', error);
                setStatus('‚ùå Failed to create invoice: ' + error.message, 'error');
            }
        }
        function loadTransactionHistory() {
            const stored = localStorage.getItem('transactionHistory');
            if (stored) {
                transactionHistory = JSON.parse(stored);
            }
        }
        
        // Save transaction
        function saveTransaction(transaction) {
            transactionHistory.unshift(transaction);
            localStorage.setItem('transactionHistory', JSON.stringify(transactionHistory));
            updateHistoryStats();
        }
        
        // Calculate totals
        function calculateTotals() {
            const now = new Date();
            const todayStart = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            const weekStart = new Date(now.setDate(now.getDate() - now.getDay()));
            const monthStart = new Date(now.getFullYear(), now.getMonth(), 1);
            
            let todayTotal = 0;
            let weekTotal = 0;
            let monthTotal = 0;
            
            transactionHistory.forEach(tx => {
                const txDate = new Date(tx.timestamp);
                const amount = tx.amount;
                
                if (txDate >= todayStart) todayTotal += amount;
                if (txDate >= weekStart) weekTotal += amount;
                if (txDate >= monthStart) monthTotal += amount;
            });
            
            return { todayTotal, weekTotal, monthTotal };
        }
        
        // Update stats display
        function updateHistoryStats() {
            const { todayTotal, weekTotal, monthTotal } = calculateTotals();
            document.getElementById('todayTotal').textContent = todayTotal.toLocaleString() + ' sats';
            document.getElementById('weekTotal').textContent = weekTotal.toLocaleString() + ' sats';
            document.getElementById('monthTotal').textContent = monthTotal.toLocaleString() + ' sats';
        }
        
        // Show/hide views
        function showProducts() {
            document.getElementById('productsView').classList.remove('hidden');
            document.getElementById('newSaleView').classList.add('hidden');
            document.getElementById('historyView').classList.add('hidden');
            document.getElementById('cartView').classList.add('hidden');
            displayProducts();
        }
        
        function showNewSale() {
            document.getElementById('newSaleView').classList.remove('hidden');
            document.getElementById('historyView').classList.add('hidden');
            document.getElementById('productsView').classList.add('hidden');
            document.getElementById('cartView').classList.add('hidden');
        }
        
        function showHistory() {
            document.getElementById('newSaleView').classList.add('hidden');
            document.getElementById('historyView').classList.remove('hidden');
            document.getElementById('productsView').classList.add('hidden');
            document.getElementById('cartView').classList.add('hidden');
            updateHistoryStats();
            filterHistory();
        }
        
        // Filter history
        function filterHistory() {
            const period = document.getElementById('periodFilter').value;
            const now = new Date();
            let startDate;
            
            if (period === 'today') {
                startDate = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            } else if (period === 'week') {
                startDate = new Date(now.setDate(now.getDate() - now.getDay()));
            } else if (period === 'month') {
                startDate = new Date(now.getFullYear(), now.getMonth(), 1);
            } else {
                startDate = new Date(0);
            }
            
            const filtered = transactionHistory.filter(tx => new Date(tx.timestamp) >= startDate);
            displayTransactions(filtered);
        }
        
        // Display transactions
        function displayTransactions(transactions) {
            const list = document.getElementById('transactionList');
            
            if (transactions.length === 0) {
                list.innerHTML = '<div class="no-transactions">No transactions yet</div>';
                return;
            }
            
            list.innerHTML = transactions.map(tx => {
                let displayText = `+${tx.amount.toLocaleString()} sats`;
                if (tx.fiatAmount && tx.currency) {
                    displayText += ` (${tx.fiatAmount} ${tx.currency})`;
                }
                
                return `
                <div class="transaction-item">
                    <div class="transaction-header">
                        <span class="transaction-item-name">${tx.itemName}</span>
                        <span class="transaction-amount">${displayText}</span>
                    </div>
                    <div class="transaction-date">
                        ${new Date(tx.timestamp).toLocaleString()}
                    </div>
                </div>
            `}).join('');
        }
        
        // Export to CSV
        function exportHistory() {
            if (transactionHistory.length === 0) {
                alert('No transactions to export');
                return;
            }
            
            const csv = [
                ['Date', 'Time', 'Item', 'Amount (sats)', 'Fiat Amount', 'Currency', 'Lightning Address'],
                ...transactionHistory.map(tx => {
                    const date = new Date(tx.timestamp);
                    return [
                        date.toLocaleDateString(),
                        date.toLocaleTimeString(),
                        tx.itemName,
                        tx.amount,
                        tx.fiatAmount || '',
                        tx.currency || '',
                        tx.lightningAddr
                    ];
                })
            ].map(row => row.join(',')).join('\n');
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `satspos_history_${Date.now()}.csv`;
            a.click();
        }
        
        // PWA Install prompt
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            document.getElementById('installPrompt').classList.remove('hidden');
        });
        
        function installApp() {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                deferredPrompt.userChoice.then((choiceResult) => {
                    if (choiceResult.outcome === 'accepted') {
                        console.log('App installed');
                    }
                    deferredPrompt = null;
                    document.getElementById('installPrompt').classList.add('hidden');
                });
            }
        }
        
        function dismissInstall() {
            document.getElementById('installPrompt').classList.add('hidden');
        }
        
        // Register service worker
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('sw.js').then(() => {
                console.log('Service Worker registered');
            });
        }
        
        // Save printer device ID for reconnection
        function savePrinterConnection() {
            if (printerDevice) {
                localStorage.setItem('printerDeviceId', printerDevice.id);
                localStorage.setItem('printerDeviceName', printerDevice.name);
            }
        }
        
        // Reconnect to saved printer
        async function reconnectToPrinter() {
            const savedDeviceId = localStorage.getItem('printerDeviceId');
            if (!savedDeviceId || !printerDevice) return false;
            
            try {
                if (!printerDevice.gatt.connected) {
                    setStatus('üîÑ Reconnecting to printer...', 'info');
                    const server = await printerDevice.gatt.connect();
                    
                    const services = await server.getPrimaryServices();
                    for (const service of services) {
                        const characteristics = await service.getCharacteristics();
                        for (const char of characteristics) {
                            if (char.properties.write || char.properties.writeWithoutResponse) {
                                printerCharacteristic = char;
                                setStatus('‚úÖ Printer reconnected!', 'success');
                                return true;
                            }
                        }
                    }
                }
                return true;
            } catch (error) {
                console.error('Reconnect failed:', error);
                reconnectAttempts++;
                if (reconnectAttempts < MAX_RECONNECT_ATTEMPTS) {
                    setTimeout(reconnectToPrinter, 2000);
                }
                return false;
            }
        }
        
        // Handle when app comes back to foreground
        document.addEventListener('visibilitychange', async () => {
            if (document.visibilityState === 'visible' && printerDevice) {
                reconnectAttempts = 0;
                await reconnectToPrinter();
            }
        });
        
        // Handle Bluetooth disconnect events
        function setupDisconnectHandler() {
            if (printerDevice) {
                printerDevice.addEventListener('gattserverdisconnected', async () => {
                    console.log('Printer disconnected');
                    setStatus('‚ö†Ô∏è Printer disconnected. Reconnecting...', 'warning');
                    reconnectAttempts = 0;
                    await reconnectToPrinter();
                });
            }
        }
        
        // Save settings to localStorage
        function saveSettings() {
            localStorage.setItem('shopName', document.getElementById('shopName').value);
            localStorage.setItem('shopAddress', document.getElementById('shopAddress').value);
            localStorage.setItem('lightningAddress', document.getElementById('lightningAddress').value);
            savePrinterConnection();
        }
        
        function loadSettings() {
            const shopName = localStorage.getItem('shopName');
            const shopAddress = localStorage.getItem('shopAddress');
            const lightningAddress = localStorage.getItem('lightningAddress');
            
            if (shopName) document.getElementById('shopName').value = shopName;
            if (shopAddress) document.getElementById('shopAddress').value = shopAddress;
            if (lightningAddress) document.getElementById('lightningAddress').value = lightningAddress;
        }
        
        window.addEventListener('load', () => {
            loadSettings();
            loadTransactionHistory();
            loadProducts();
            updateHistoryStats();
            updateExchangeRates();
            // Update rates every minute
            setInterval(updateExchangeRates, RATE_UPDATE_INTERVAL);
        });
        
        // ESC/POS commands
        const ESC = '\x1B';
        const GS = '\x1D';
        const INIT = ESC + '@';
        const CENTER = ESC + 'a' + '\x01';
        const LEFT = ESC + 'a' + '\x00';
        const BOLD_ON = ESC + 'E' + '\x01';
        const BOLD_OFF = ESC + 'E' + '\x00';
        const CUT = GS + 'V' + '\x41' + '\x00';
        const NEWLINE = '\n';
        
        function setStatus(message, type = 'info') {
            const box = document.getElementById('statusBox');
            box.className = `status ${type}`;
            box.innerHTML = message;
        }
        
        async function connectPrinter() {
            if (!navigator.bluetooth) {
                setStatus('‚ùå Web Bluetooth not supported. Use Chrome or Edge on Android.', 'error');
                return;
            }
            
            try {
                setStatus('üîç Scanning for Bluetooth devices...', 'info');
                
                printerDevice = await navigator.bluetooth.requestDevice({
                    acceptAllDevices: true,
                    optionalServices: [
                        '000018f0-0000-1000-8000-00805f9b34fb',
                        '49535343-fe7d-4ae5-8fa9-9fafd205e455',
                        '00001101-0000-1000-8000-00805f9b34fb',
                    ]
                });
                
                setStatus('üì° Connecting to ' + printerDevice.name + '...', 'info');
                
                const server = await printerDevice.gatt.connect();
                
                const services = await server.getPrimaryServices();
                let found = false;
                
                for (const service of services) {
                    const characteristics = await service.getCharacteristics();
                    for (const char of characteristics) {
                        if (char.properties.write || char.properties.writeWithoutResponse) {
                            printerCharacteristic = char;
                            found = true;
                            break;
                        }
                    }
                    if (found) break;
                }
                
                if (!found) {
                    throw new Error('No writable characteristic found');
                }
                
                await sendToPrinter(INIT + CENTER + BOLD_ON + 'Connected!' + BOLD_OFF + NEWLINE + NEWLINE + CUT);
                
                setupDisconnectHandler();
                savePrinterConnection();
                
                setStatus('‚úÖ Printer connected: ' + printerDevice.name, 'success');
                document.getElementById('printerInfo').classList.remove('hidden');
                document.getElementById('printerName').textContent = printerDevice.name;
                document.getElementById('setupSection').classList.add('hidden');
                document.getElementById('transactionSection').classList.remove('hidden');
                saveSettings();
                
            } catch (error) {
                console.error('Bluetooth error:', error);
                setStatus('‚ùå Connection failed: ' + error.message, 'error');
            }
        }
        
        function skipPrinter() {
            setStatus('üìù Printer skipped - receipts will be saved as images', 'warning');
            document.getElementById('setupSection').classList.add('hidden');
            document.getElementById('transactionSection').classList.remove('hidden');
            saveSettings();
        }
        
        async function sendToPrinter(text) {
            if (!printerCharacteristic) {
                throw new Error('Printer not connected');
            }
            
            const encoder = new TextEncoder();
            const data = encoder.encode(text);
            
            const chunkSize = 20;
            for (let i = 0; i < data.length; i += chunkSize) {
                const chunk = data.slice(i, i + chunkSize);
                await printerCharacteristic.writeValue(chunk);
                await new Promise(resolve => setTimeout(resolve, 50));
            }
        }
        
        async function createInvoice() {
            const lightningAddr = document.getElementById('lightningAddress').value.trim();
            const itemName = document.getElementById('itemName').value.trim();
            
            // Get amount based on active input mode
            let amount;
            let fiatAmount = null;
            let currency = null;
            
            if (document.getElementById('fiatInput').classList.contains('hidden')) {
                // Sats mode
                amount = parseInt(document.getElementById('satsAmount').value);
            } else {
                // Fiat mode
                const fiatValue = parseFloat(document.getElementById('fiatAmount').value);
                currency = document.getElementById('currency').value.toUpperCase();
                const rate = exchangeRates[currency.toLowerCase()];
                
                if (!rate) {
                    setStatus('‚ùå Exchange rate unavailable. Please try again.', 'error');
                    return;
                }
                
                const btcAmount = fiatValue / rate;
                amount = Math.round(btcAmount * 100000000);
                fiatAmount = fiatValue;
            }
            
            if (!lightningAddr || !itemName || !amount || amount <= 0) {
                setStatus('‚ùå Please fill all fields', 'error');
                return;
            }
            
            localStorage.setItem('lightningAddress', lightningAddr);
            
            setStatus('üîç Resolving lightning address...', 'info');
            
            try {
                const [user, domain] = lightningAddr.split('@');
                const lnurlUrl = `https://${domain}/.well-known/lnurlp/${user}`;
                
                const lnurlResp = await fetch(lnurlUrl);
                const lnurlData = await lnurlResp.json();
                
                setStatus('üìÑ Requesting invoice...', 'info');
                
                const callback = lnurlData.callback;
                const msat = amount * 1000;
                const invoiceUrl = `${callback}?amount=${msat}&memo=${encodeURIComponent(itemName)}`;
                
                const invoiceResp = await fetch(invoiceUrl);
                const invoiceData = await invoiceResp.json();
                
                currentInvoice = invoiceData.pr || invoiceData.paymentRequest;
                
                if (!currentInvoice) {
                    throw new Error('No invoice in response');
                }
                
                currentTransaction = {
                    shopName: document.getElementById('shopName').value,
                    shopAddress: document.getElementById('shopAddress').value,
                    lightningAddr,
                    itemName,
                    amount,
                    fiatAmount,
                    currency,
                    invoice: currentInvoice,
                    timestamp: new Date().toISOString()
                };
                
                document.getElementById('qrcode').innerHTML = '';
                new QRCode(document.getElementById('qrcode'), {
                    text: currentInvoice,
                    width: 256,
                    height: 256
                });
                
                document.getElementById('invoiceText').textContent = currentInvoice;
                document.getElementById('transactionSection').classList.add('hidden');
                document.getElementById('invoiceSection').classList.remove('hidden');
                
                setStatus('‚úÖ Invoice generated! Waiting for payment...', 'success');
                
            } catch (error) {
                console.error('Invoice error:', error);
                setStatus('‚ùå Failed to create invoice: ' + error.message, 'error');
            }
        }
        
        async function confirmPayment() {
            setStatus('üñ®Ô∏è Printing receipt...', 'info');
            
            try {
                if (printerCharacteristic) {
                    await printReceipt();
                } else {
                    downloadReceipt();
                }
                
                setStatus('‚úÖ Transaction complete!', 'success');
                
                // Save to history
                saveTransaction({
                    itemName: currentTransaction.itemName,
                    amount: currentTransaction.amount,
                    fiatAmount: currentTransaction.fiatAmount,
                    currency: currentTransaction.currency,
                    lightningAddr: currentTransaction.lightningAddr,
                    timestamp: currentTransaction.timestamp,
                    invoice: currentTransaction.invoice
                });
                
                setTimeout(() => {
                    document.getElementById('invoiceSection').classList.add('hidden');
                    document.getElementById('transactionSection').classList.remove('hidden');
                    document.getElementById('itemName').value = '';
                    document.getElementById('fiatAmount').value = '';
                    document.getElementById('satsAmount').value = '';
                    document.getElementById('conversionDisplay').textContent = '';
                    document.getElementById('satsConversionDisplay').textContent = '';
                    setStatus('Ready for next transaction', 'info');
                }, 3000);
                
            } catch (error) {
                console.error('Print error:', error);
                setStatus('‚ö†Ô∏è Print failed but transaction complete', 'warning');
            }
        }
        
        async function printReceipt() {
            const t = currentTransaction;
            
            let receipt = INIT;
            receipt += CENTER + BOLD_ON + t.shopName + BOLD_OFF + NEWLINE;
            receipt += CENTER + t.shopAddress + NEWLINE;
            receipt += CENTER + new Date(t.timestamp).toLocaleString() + NEWLINE;
            receipt += LEFT + '--------------------------------' + NEWLINE;
            
            // If cart items exist, print detailed receipt
            if (t.cartItems && t.cartItems.length > 0) {
                t.cartItems.forEach(item => {
                    const itemTotal = item.price * item.quantity;
                    receipt += LEFT + item.name + ' x' + item.quantity + NEWLINE;
                    receipt += LEFT + '  ' + itemTotal.toLocaleString() + ' sats' + NEWLINE;
                });
                receipt += LEFT + '--------------------------------' + NEWLINE;
                receipt += LEFT + BOLD_ON + 'Total: ' + t.amount + ' sats' + BOLD_OFF + NEWLINE;
            } else {
                receipt += LEFT + 'Item: ' + t.itemName + NEWLINE;
                
                if (t.fiatAmount && t.currency) {
                    receipt += LEFT + 'Amount: ' + t.fiatAmount + ' ' + t.currency + NEWLINE;
                    receipt += LEFT + '        (' + t.amount + ' sats)' + NEWLINE;
                } else {
                    receipt += LEFT + 'Amount: ' + t.amount + ' sats' + NEWLINE;
                }
            }
            
            receipt += LEFT + 'To: ' + t.lightningAddr + NEWLINE;
            receipt += LEFT + '--------------------------------' + NEWLINE;
            receipt += CENTER + NEWLINE;
            receipt += CENTER + 'PAID' + NEWLINE;
            receipt += CENTER + 'Thank you!' + NEWLINE;
            receipt += CENTER + 'SatsPOS' + NEWLINE;
            receipt += NEWLINE + NEWLINE + NEWLINE;
            receipt += CUT;
            
            await sendToPrinter(receipt);
        }
        
        function downloadReceipt() {
            const t = currentTransaction;
            const text = `
${t.shopName}
${t.shopAddress}
${new Date(t.timestamp).toLocaleString()}
--------------------------------
Item: ${t.itemName}
Amount: ${t.amount} sats
To: ${t.lightningAddr}
--------------------------------

Invoice: ${t.invoice}

PAID
Thank you!
SatsPOS
            `;
            
            const blob = new Blob([text], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `receipt_${Date.now()}.txt`;
            a.click();
        }
        
        function cancelTransaction() {
            document.getElementById('invoiceSection').classList.add('hidden');
            document.getElementById('transactionSection').classList.remove('hidden');
            setStatus('Transaction cancelled', 'warning');
        }
    </script>
</body>
</html>
